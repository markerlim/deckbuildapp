import React, { useState, useEffect } from "react";
import { Link, useNavigate } from "react-router-dom";
import { signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "firebase/auth";
import { auth } from "../Firebase";
import { Box, CircularProgress } from "@mui/material";
import { getFirestore, doc, setDoc, getDoc } from "firebase/firestore";
import { Google } from "@mui/icons-material";

const Login = () => {
    const [err, setErr] = useState(false);
    const [loading, setLoading] = useState(true);
    const navigate = useNavigate();
    const db = getFirestore();

    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async user => {
            if (user) {
                console.log('User is signed in');

                // Check if the user document exists in Firestore
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    console.log('Creating user document in Firestore');
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        displayName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                    });
                } else {
                    console.log('User document already exists');
                }

                navigate('/');
            } else {
                console.log('No user is signed in');
                setLoading(false);
            }
        });

        return () => unsubscribe();
    }, [navigate, db]);

    const handleSubmit = async (e) => {
        e.preventDefault();
        const email = e.target[0].value;
        const password = e.target[1].value;

        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (err) {
            setErr(true);
        }
    };

    const handleGoogleSignIn = async () => {
        const provider = new GoogleAuthProvider();

        try {
            console.log('Attempting Google Sign-in');
            await signInWithPopup(auth, provider);
            console.log('Google Sign-in completed');
        } catch (err) {
            console.error(err);
            setErr(true);
        }
    };

    if (loading) return <div><CircularProgress /></div>;
    return (
        <Box className="formContainer" style={{ marginTop: '-64px', display: 'flex', flexDirection: 'column', gap: '5px', position: 'relative' }}>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: '1px', alignItems: 'center', justifyContent: 'center', marginTop: { xs: '-90px' } }}>
                <div className="logo"><Box p={1}><img style={{ width: "auto", height: "80px" }} alt="uniondeck" src="/icons/geekstackicon.svg" /></Box></div>
                <div style={{ fontFamily: 'league spartan', fontSize: '30px', color: '#ffffff' }}><strong>GEEKSTACK</strong></div>
            </Box>
            <Box className="formWrapper">
                <span className="title">Welcome to the place for Cards!</span>
                <form onSubmit={handleSubmit}>
                    <input type="email" placeholder="Email" />
                    <input type="password" placeholder="Password" />
                    <button>Login</button>
                    {err && <span style={{ color: "red" }}>something went wrong</span>}
                </form>
                <button style={{ display: "flex", flexDirection: "row", alignItems: "center", gap: 4, border: "none", padding: 5, cursor: "pointer", borderRadius: "5px", backgroundColor: "#784C9A", color: "#f2f3f8" }} onClick={handleGoogleSignIn}>
                    <Google /><span>Login with Google</span>
                </button>
                <p>Don't have an account? <Link to="/register">Register</Link></p>
            </Box>
            <Box sx={{ position: 'absolute', bottom: 0, color: "#ffffff", paddingBottom: '30px', display: 'flex', flexDirection: 'column', gap: '10px',textAlign:'center' }}>
                <Box sx={{ display: 'flex', flexDirection: 'row', gap: '30px', justifyContent: 'center', alignItems: 'center' }}>
                    <Box component={Link} to="https://discord.gg/wUZCZB9aM3" sx={{cursor:'pointer'}}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="33" height="26" viewBox="0 0 33 26" fill="none">
                            <path d="M27.9541 2.17749C25.818 1.16025 23.5339 0.420959 21.146 0C20.8527 0.539654 20.5101 1.2655 20.2739 1.84291C17.7354 1.45436 15.2203 1.45436 12.7286 1.84291C12.4924 1.2655 12.142 0.539654 11.8461 0C9.45561 0.420959 7.16891 1.16297 5.03277 2.18288C0.724134 8.8097 -0.443865 15.2719 0.140135 21.6424C2.99785 23.8144 5.76731 25.1339 8.49004 25.9973C9.1623 25.0556 9.76186 24.0546 10.2784 22.9996C9.29466 22.6192 8.35248 22.1497 7.46223 21.6046C7.69841 21.4265 7.92943 21.2404 8.15262 21.0488C13.5825 23.6337 19.4822 23.6337 24.8473 21.0488C25.0731 21.2404 25.3041 21.4265 25.5377 21.6046C24.6448 22.1523 23.7 22.6218 22.7163 23.0023C23.2328 24.0546 23.8298 25.0584 24.5046 26C27.23 25.1366 30.002 23.8172 32.8597 21.6424C33.545 14.2574 31.6892 7.85452 27.9541 2.17749ZM11.0181 17.7246C9.38812 17.7246 8.05138 16.1758 8.05138 14.2898C8.05138 12.4037 9.35957 10.8522 11.0181 10.8522C12.6767 10.8522 14.0134 12.401 13.9848 14.2898C13.9874 16.1758 12.6767 17.7246 11.0181 17.7246ZM21.9818 17.7246C20.3518 17.7246 19.015 16.1758 19.015 14.2898C19.015 12.4037 20.3232 10.8522 21.9818 10.8522C23.6403 10.8522 24.977 12.401 24.9485 14.2898C24.9485 16.1758 23.6403 17.7246 21.9818 17.7246Z" fill="white" />
                        </svg>
                    </Box>
                    <Box component={Link} to="https://www.tiktok.com/@geekstackapp" sx={{cursor:'pointer'}}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="23" height="26" viewBox="0 0 23 26" fill="none">
                            <path d="M11.8666 0.0216769C13.286 8.23674e-08 14.6949 0.0112719 16.1031 0C16.1499 1.76102 16.8644 3.34603 18.0011 4.52004L17.9994 4.51831C19.2228 5.62036 20.8147 6.33482 22.5697 6.45621L22.594 6.45795V10.8245C20.9361 10.7829 19.3771 10.4005 17.9716 9.74328L18.0427 9.77276C17.3629 9.44587 16.7881 9.11032 16.2418 8.73574L16.2869 8.76522C16.2765 11.9292 16.2973 15.0931 16.2652 18.2458C16.1759 19.8525 15.6418 21.3178 14.7851 22.5413L14.8025 22.5144C13.3701 24.5659 11.0498 25.9124 8.41128 25.9922H8.39914C8.29249 25.9974 8.16676 26 8.04017 26C6.54014 26 5.13808 25.5821 3.94326 24.8563L3.97794 24.8763C1.80333 23.5679 0.303294 21.3291 0.0258316 18.7253L0.0223633 18.6897C0.00068655 18.1478 -0.00971838 17.6059 0.0119584 17.0752C0.436823 12.9315 3.90858 9.72594 8.12861 9.72594C8.6029 9.72594 9.06765 9.76669 9.5194 9.84386L9.47084 9.83692C9.49252 11.4401 9.42749 13.0442 9.42749 14.6474C9.06071 14.5148 8.63758 14.4376 8.19624 14.4376C6.57656 14.4376 5.19878 15.4729 4.68894 16.9183L4.68114 16.9443C4.56582 17.3145 4.49905 17.7403 4.49905 18.1808C4.49905 18.3594 4.51032 18.5363 4.53113 18.7097L4.5294 18.6889C4.81727 20.4629 6.33811 21.8016 8.17197 21.8016C8.22486 21.8016 8.27688 21.8008 8.32891 21.7982H8.3211C9.58963 21.76 10.6908 21.0776 11.3134 20.0692L11.322 20.0536C11.5535 19.7311 11.7122 19.3409 11.7651 18.9169L11.766 18.9048C11.8744 16.9651 11.831 15.0367 11.8414 13.0971C11.8518 8.73054 11.831 4.37437 11.8631 0.0190756L11.8666 0.0216769Z" fill="white" />
                        </svg>
                    </Box>
                    <Box component={Link} to="https://www.buymeacoffee.com/uniondeck" sx={{cursor:'pointer'}}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="26" viewBox="0 0 18 26" fill="none">
                            <path d="M17.8819 6.94967L17.7389 6.22816C17.61 5.58031 17.3186 4.96822 16.6545 4.73421C16.4411 4.65946 16.1995 4.62805 16.037 4.47313C15.8723 4.31821 15.8246 4.07662 15.7867 3.85345C15.7163 3.44394 15.6513 3.03443 15.5787 2.62601C15.517 2.27392 15.4682 1.87849 15.3079 1.55674C15.0966 1.1234 14.6611 0.869891 14.2289 0.703054C14.007 0.620101 13.7806 0.549929 13.5507 0.492884C12.4673 0.207962 11.3298 0.102876 10.2172 0.0422084C8.88118 -0.0312497 7.54161 -0.00880276 6.2088 0.109376C5.21753 0.199295 4.17209 0.308713 3.22958 0.651053C2.88507 0.776722 2.52973 0.928392 2.26756 1.19381C1.9458 1.52099 1.8418 2.028 2.0758 2.43534C2.24264 2.72459 2.5254 2.92935 2.82549 3.06368C3.21549 3.23919 3.62392 3.37135 4.04209 3.46019C5.2067 3.71803 6.41355 3.81878 7.60308 3.86103C8.9226 3.9152 10.2432 3.87186 11.5573 3.7332C11.8812 3.69744 12.2052 3.65411 12.528 3.60428C12.9093 3.54577 13.1542 3.04852 13.0415 2.70076C12.9072 2.28583 12.5464 2.1255 12.138 2.18833C11.6332 2.2685 11.098 2.30533 10.6408 2.3465C9.36569 2.43317 8.08625 2.43534 6.81006 2.353C6.39131 2.32529 5.97335 2.28664 5.55662 2.23708C5.46345 2.22625 5.36162 2.21 5.27712 2.19808C5.01386 2.15908 4.75277 2.11141 4.49277 2.05725C4.37251 2.028 4.37251 1.85683 4.49277 1.82758H4.49818C4.79827 1.76257 5.10161 1.71057 5.40603 1.66832H5.4082C5.55012 1.65857 5.69312 1.63366 5.83504 1.61632C7.06782 1.48837 8.30791 1.44494 9.54661 1.48632C10.2768 1.5069 11.0059 1.5589 11.7317 1.64232L11.9787 1.67591C12.268 1.71924 12.5562 1.77124 12.8433 1.83299C13.2679 1.92508 13.8129 1.95541 14.0024 2.42017C14.062 2.56859 14.0891 2.73218 14.1227 2.8871L14.4683 4.49479C14.4756 4.52927 14.4758 4.56488 14.4687 4.59941C14.4617 4.63394 14.4476 4.66666 14.4274 4.69552C14.4072 4.72439 14.3812 4.74877 14.3512 4.76717C14.3211 4.78557 14.2876 4.79759 14.2527 4.80247H14.2495C14.2094 4.80897 14.1682 4.8133 14.1281 4.81872C12.424 5.03613 10.7077 5.14288 8.98977 5.13831C7.28761 5.13655 5.58729 5.02655 3.89909 4.80897C3.74742 4.79055 3.58167 4.76346 3.44733 4.74396C3.09416 4.69196 2.74423 4.62696 2.39323 4.56954C1.96747 4.49913 1.56121 4.53488 1.17662 4.74396C0.862449 4.9173 0.605694 5.18164 0.445357 5.5034C0.278521 5.84574 0.22977 6.21841 0.156102 6.58675C0.0813508 6.95509 -0.0345681 7.35268 0.00984942 7.73077C0.104101 8.54654 0.673945 9.20955 1.49404 9.35797C5.54954 10.0817 9.688 10.2189 13.7825 9.76531C13.8603 9.75646 13.9391 9.76518 14.0131 9.79082C14.087 9.81646 14.1543 9.85838 14.2099 9.91348C14.2656 9.96858 14.3081 10.0355 14.3344 10.1092C14.3608 10.1829 14.3702 10.2616 14.3621 10.3395L14.2852 11.0946L13.1823 21.8274C13.1379 22.2715 13.1314 22.7287 13.0469 23.1675C12.9148 23.8576 12.4478 24.2812 11.7664 24.4361C11.1413 24.578 10.5043 24.6528 9.86403 24.6582C9.15335 24.6625 8.44484 24.6311 7.73416 24.6343C6.9769 24.6387 6.04846 24.5693 5.46454 24.006C4.94994 23.5098 4.87952 22.7341 4.80911 22.0635L4.01718 14.466L3.66834 11.1141C3.62825 10.7338 3.3585 10.3612 2.93382 10.3796C2.56981 10.3958 2.15597 10.7046 2.19931 11.1152L2.44631 13.4823L3.47441 23.3538C3.63367 24.8098 4.74627 25.5942 6.1243 25.8152C6.92815 25.9452 7.75258 25.9712 8.56943 25.9842C9.61595 26.0015 10.6733 26.0416 11.7025 25.852C13.2278 25.5725 14.373 24.5542 14.5365 22.9736C14.9049 19.3638 15.2765 15.7552 15.6459 12.1454L15.8788 9.88448C15.8903 9.77236 15.9376 9.66692 16.0137 9.5838C16.0898 9.50067 16.1907 9.44427 16.3013 9.42297C16.7368 9.33847 17.1539 9.1933 17.4648 8.86179C17.9578 8.33312 18.0564 7.64519 17.8819 6.94967ZM16.2807 7.78602C16.1237 7.93444 15.8875 8.00378 15.6546 8.03844C13.0372 8.42737 10.383 8.62345 7.73741 8.53679C5.84371 8.47179 3.97059 8.26161 2.09639 7.99728C1.91222 7.97128 1.71396 7.93769 1.58721 7.80227C1.34887 7.5466 1.46696 7.03309 1.52871 6.72433C1.58505 6.44266 1.69338 6.06457 2.0303 6.02449C2.55465 5.96274 3.16349 6.18483 3.6835 6.26283C4.3086 6.35816 4.93586 6.43508 5.56529 6.4925C8.252 6.73734 10.9842 6.69833 13.6601 6.34083C14.1476 6.27583 14.634 6.19999 15.1172 6.11332C15.5495 6.03532 16.0272 5.89015 16.2872 6.33649C16.4671 6.64092 16.4909 7.04826 16.4627 7.39168C16.4542 7.54166 16.3887 7.68271 16.2797 7.78602H16.2807ZM9.60836 12.0111C8.67451 12.4119 7.61499 12.8648 6.24022 12.8648C5.66562 12.8634 5.09384 12.7843 4.54043 12.6297L5.49054 22.3842C5.56095 23.2292 6.2673 23.8792 7.11557 23.8792C7.11557 23.8792 8.46218 23.9497 8.91177 23.9497C9.39603 23.9497 10.8466 23.8792 10.8466 23.8792C11.6949 23.8792 12.4002 23.2292 12.4706 22.3842L13.4889 11.6048C13.0295 11.4387 12.5453 11.3515 12.0567 11.347C11.1619 11.347 10.4415 11.6547 9.60836 12.0111Z" fill="white" />
                        </svg>
                    </Box>
                </Box>
                <Box>Should there be queries, you may find the developer via Discord, user Aegis</Box>
                <Box>Disclaimer: Assets found on this websites are from Bandai we do not own any of it.</Box>
            </Box>
        </Box>
    )
}

export default Login
